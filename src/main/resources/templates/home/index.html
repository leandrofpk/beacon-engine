<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<html>
<head>
    <title>Inmetro Randomness Beacon (Prototype Implementation) - Inmetro</title>

    <link rel="stylesheet" type="text/css" th:href="@{/css/default.css}"/>
    <link rel="stylesheet" media="all" type="text/css" th:href="@{/css/jquery-ui.css}" />
    <link rel="stylesheet" media="all" type="text/css" th:href="@{/css/jquery-ui-timepicker-addon.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/beacon.css}" media="all"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/generic-nist-exit-script.css}" media="all"/>

    <script th:src="@{/js/jquery-1.9.1.min.js}"></script>
    <script th:src="@{/js/jquery-ui.min.js}"></script>
    <script th:src="@{/js/jquery-ui-timepicker-addon.js}"></script>
    <script th:src="@{/js/beacon.js}"></script>
    <!--<script type="text/javascript" src="scripts/federated-analytics.all.min.js?agency=NIST&subagency=beacon&pua=UA-42404149-35&yt=true"></script>-->
    <script th:src="@{/js/generic-nist-exit-script.js}"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            // set-up time picker and make sure to update when a new value is selected
            $("#beacon-time").datetimepicker({
                timeFormat: "hh:mm tt",
                onClose: function( text, inst ) {
                    var dt = new Date(text);
                    getBeacon({type: "record", value: (dt.getTime() / 1000)});
                }
            });
            // handle button clicks
            $( ".beacon-nav > input[type=submit]" ).button().click(function( event ) {
                var requestType = event.target.value.toLowerCase().replace(" ", "-");
                var record = 0;
                if (data != undefined) {
                    record = data.timestamp;
                }
                getBeacon({type: requestType, value: record});
                event.target.blur();
            });
            var data;
            // initialize with the last value
            getBeacon({type: "last"});

            // function for communicating with the server to retrieve new beacon record
            function getBeacon(record) {
                var resturl = "/rest/record";
                var param = {};
                if (record.type == "first") {
                    record.value = 0;
                } else if (record.type == "last" || record.type == "next" || record.type == "previous" || record.type == "start-chain") {
                    resturl += "/" + record.type;
                }
                // force browsers to not cache first and last records
                // last record changes every minute, first only rarely (if ever)
                if (record.type == "last" || record.type == "first") {
                    param = { 'nocache': new Date().getTime() };
                }
                if (record.type != "last") {
                    resturl += "/" + record.value;
                }
                $.ajax({
                    url: resturl,
                    type: "GET",
                    data: param,
                    dataType : "xml",
                    success: function( xml ) {
                        data = new BeaconData(
                            // version
                            $(xml).find("version").text(),
                            // frequency
                            parseInt($(xml).find("frequency").text(), 10),
                            // time in seconds
                            parseInt($(xml).find("timeStamp").text(), 10),
                            // seed
                            $(xml).find("seedValue").text(),
                            // previous output
                            $(xml).find("previousOutputValue").text(),
                            // signature
                            $(xml).find("signatureValue").text(),
                            // output value
                            $(xml).find("outputValue").text(),
                            // status code
                            parseInt($(xml).find("statusCode").text(), 10));
                        $("div#beacon-output").children().remove();
                        $("div#beacon-output").append(data.toHtml());
                        var curr = new Date(data.timestamp * 1000);
                        $("input#beacon-time").val(dateString(curr) + " " + timeString(curr));
                    },
                    error: function( xhr, status, errorThrown ) {
                        // 404 error: assume the record does not exist, otherwise return an error message
                        console.log(xhr + " " + status + " " + errorThrown)

                        if (xhr.status == 404) {
                            alert("Requested value does not exist.");
                        } else {
                            alert( "Error communicating with the server! (" + xhr.status + " : " + errorThrown + ")");
                        }
                    }
                });
            }
        });
    </script>

</head>
<body>

<!--<div id="top-header"><a href="http://itl.nist.gov/"><img src="images/top-banner.gif" width="400" height="36" alt="National Institute of Standards and Technology (NIST) - Information technology Laboratory (ITL)" /></a></div>-->
<!--<div id="header"><h1>Computer Security Division</h1></div>-->
<div id="content">
    <!--<div class="notice">-->
        <!--<h3>NOTICES</h3>-->
        <!--<ol>-->
            <!--<li>The public key certificate used to verify beacon records expired on 7 May, 2017. The beacon signing key has also changed. We plan to publish a new self-signed certificate in the near future, in the meantime users can download the <a href="/certificate/pubkey.pem">public key</a>.</li>-->
            <!--<li>Version 2.0 of the NIST beacon is in progress for a future deployment. We plan to have a beta release of Version 2.0 available in the near future. This version will make significant changes to the REST interface.</li>-->
        <!--</ol>-->
    <!--</div>-->
    <h2>Inmetro Randomness Beacon (Prototype Implementation) -- work in progress</h2>
    <h3 class="warning">WARNING: DO NOT USE BEACON GENERATED VALUES AS SECRET CRYPTOGRAPHIC KEYS.</h3>
    <!--<p>An overview of this project can be found at: <a href="http://www.nist.gov/itl/csd/ct/nist_beacon.cfm">http://www.nist.gov/itl/csd/ct/nist_beacon.cfm</a></p>-->
    <!--<p>This prototype implementation generates full-entropy bit-strings and posts them in blocks of 512 bits every 60 seconds. Each such value is sequence-numbered, time-stamped and signed, and includes the hash of the previous value to chain the sequence of values together and prevent even the source to retroactively change an output package without being detected.</p>-->
    <p>Currently implemented calls are listed below. Users submitting a request need to provide the record generation time in POSIX format (number of seconds since midnight UTC, January 1, 1970 (see <a href="http://en.wikipedia.org/wiki/Unix_time">http://en.wikipedia.org/wiki/Unix_time</a> for more information and <a href="http://www.epochconverter.com">http://www.epochconverter.com</a> for an online timestamp converter.)</p>
    <dl>
        <dt>Current Record (or next closest):</dt>
        <dd>https://beacon.nist.gov/rest/record/&lt;timestamp&gt;</dd>
        <dt>Previous Record:</dt>
        <dd>https://beacon.nist.gov/rest/record/previous/&lt;timestamp&gt;</dd>
        <dt>Next Record:</dt>
        <dd>https://beacon.nist.gov/rest/record/next/&lt;timestamp&gt;</dd>
        <dt>Last Record:</dt>
        <dd>https://beacon.nist.gov/rest/record/last</dd>
        <dt>Start Chain Record:</dt>
        <dd>https://beacon.nist.gov/rest/record/start-chain/&lt;timestamp&gt;</dd>
    </dl>
    <p>If a request for a next or previous record results in no record found, a 404 response is returned.</p>
    <!--<h3>Schema</h3>-->
    <!--<p>The data source schema for the NIST Beacon REST API described above can be viewed by clicking <a href="/record/0.1/beacon-0.1.0.xsd">here</a>.</p>-->
    <p class="note">Note: Not all browsers will display this file appropriately, you may get better results by saving the file locally and using an editor of your choice.</p>
    <!--<h3>Certificate</h3>-->
    <!--<p>NIST Beacon is currently using an X.509 certificate with the Federal Common Policy CA as the ultimate root authority. The certificate is available <a href="/certificate/beacon.cer">here</a></p>-->
    <h3>Viewer</h3>
    <p>The example application below uses the REST API described above to navigate the data.</p>
    <p>To visit an arbitrary time value please click on the input control containing the date and time value to display a calendar to select the desired value.</p>
    <div class="beacon-input">
        <div class="beacon-nav">
            <input type="submit" value="First" />
            <input type="submit" value="Start Chain" />
            <input type="submit" value="Previous" />
            <input type="submit" value="Next" />
            <input type="submit" value="Last" />
        </div>
        <!--<input type="text" name="beacon-time" id="beacon-time" value="" />-->
    </div>
    <!--<div id="beacon-output"></div>-->
</div>
<div id="footer">
    <dl class="pageDates">
        <dt>Last updated On:</dt>
        <dd>May 13, 2014</dd>
        <dt>Created On:</dt>
        <dd>December 08, 2012</dd>
    </dl>
    <p><a href="http://www.nist.gov/public_affairs/disclaimer.cfm">Disclaimer Notice</a> &amp; <a href="http://www.nist.gov/public_affairs/privacy.cfm">Privacy Statement / Security Notice</a></p>
    <p>Send comments or suggestions to <a href="mailto:webmaster-csrc@nist.gov">webmaster-csrc@nist.gov</a></p>
    <p><a href="http://inmetro.gov.br">Inmetro</a></p>
</div>
</body>
</html>
